# Shell

- [Shell](#shell)
  - [標準串流（Standard Streams）](#標準串流standard-streams)
    - [標準輸入（Standard Input, stdin）](#標準輸入standard-input-stdin)
    - [標準輸出（Standard Output, stdout）](#標準輸出standard-output-stdout)
    - [標準錯誤輸出（Standard Error, stderr）](#標準錯誤輸出standard-error-stderr)
  - [重新導向（Redirection）](#重新導向redirection)
    - [輸出重新導向](#輸出重新導向)
    - [輸入重新導向](#輸入重新導向)
    - [標準錯誤重新導向](#標準錯誤重新導向)
  - [管線（Pipeline）](#管線pipeline)
    - [基本概念](#基本概念)
    - [範例](#範例)
    - [管線內部機制](#管線內部機制)
    - [優點](#優點)
    - [限制](#限制)


## 標準串流（Standard Streams）

指程式與作業系統間進行資料交換的三個主要通道，會在程式執行時自動建立，並由以下三個檔案描述子（File Descriptor, FD）為代表：

### 標準輸入（Standard Input, stdin）

- 描述子 `0`。
- 提供程式讀取輸入資料的通道，預設來源是鍵盤。
- 使用者可以在互動式程式中輸入資料。

### 標準輸出（Standard Output, stdout）

- 描述子 `1`。
- 用於輸出程式的正常運作結果，預設輸出目標是終端機。
- 顯示程式的執行結果。

### 標準錯誤輸出（Standard Error, stderr）

- 描述子 `1`。
- 用於輸出錯誤訊息，預設目標也是終端機。
- 將錯誤訊息與正常輸出區分開。
- 可以獨立重新導向以便單獨記錄錯誤。

## 重新導向（Redirection）

一般來說，指令執行時需要資料的輸入以及執行結果的輸出：

- 鍵盤輸入的模式稱為*預設標準輸入*
- 螢幕輸出的模式稱為*預設標準輸出*

變更標準輸入或標準輸出的方式稱為**重新導向**。

### 輸出重新導向

- 基本輸出重新導向

    將命令的標準輸出重新導向到文件，會覆蓋文件內容，若文件不存在則創建。

    ```shell
    command > file
    ```

    範例：

    ```shell
    # 將目錄查詢結果轉存到 file.txt
    ls > file.txt
    ```

- 追加輸出重新導向

    將標準輸出追加到文件末尾，而不是覆蓋。

    ```shell
    command >> file
    ```

    範例：

    ```shell
    # 將目錄查詢結加到 file.txt 末尾
    ls >> file.txt
    ```

### 輸入重新導向

- 基本輸入重新導向

    從文件而不是標準輸入（鍵盤）讀取數據。

    > 有時可省略此符號

    ```shell
    command < file
    ```

    範例：

    ```shell
    # 將 file.txt 的內容作為 wc 的輸入計算 file.txt 的行數
    wc -l < file.txt
    ```

### 標準錯誤重新導向

- 單獨重新導向標準錯誤

    將標準錯誤信息重新導向到文件。

    ```shell
    command 2> file
    ```

    範例：

    ```shell
    ls file_not_exist 2> error.log
    ```

- 追加重新導向標準錯誤

    將標準錯誤信息加到文件。

    ```shell
    command 2>> file
    ```

    範例：

    ```shell
    ls file_not_exist 2> error.log
    ```

## 管線（Pipeline）

通過連接多個指令的標準輸出和標準輸入，實現資料流的處理機制，允許用戶將一個指令的輸出作為另一個指令的輸入。

### 基本概念

1. 資料流：資料由一個指令的標準輸出流向下一個指令的標準輸入，無需存到中間文件。
2. 串連執行：各指令按順序執行，首個指令執行完成部分輸出後，這些資料立即進入下一個指令處理，直到整個資料流處理完成。
3. 靈活組合：可通過管道將多個指令組合成複雜的工作流程，每個指令專注於完成一個具體的任務。

語法：

```shell
command1 | command2 | command3
```

### 範例

1. 查看當前目錄中的 .txt 文件

    ```shell
    ls | grep '.txt'
    ```

2. 統計目錄中 .txt 文件數量

    ```shell
    ls | grep '.txt' | wc -l
    ```

3. 查找大文件

    ```shell
    du -h | sort -h | tail -n 10
    ```

### 管線內部機制

1. 標準輸入和輸出：
   - UNIX 的管線機制依賴於將一個指令的 stdout 傳遞給下一個指令的 stdin。
2. 管道檔案描述子：
   - 系統通過建立一個臨時的管道，實現兩指令間的資料傳遞。
   - 使用 pipe() 系統呼叫創建的兩個檔案描述子：一個用於讀取，另一個用於寫入。
3. 並行執行：
   - 通常管線中的指令以並行方式執行，不是等一個指令執行完才執行下一個指令。
   - 每個指令的執行會停留在輸入或輸出操作上，直到有可用的資料。

### 優點

1. 高效率，不需將中間結果寫入檔案，直接在記憶體中傳遞。
2. 高靈活度，透過組合多個小工具，可以完成複雜的任務。
3. 簡化操作，通過組合指令，無需手動處理中間文件或步驟。

### 限制

1. 管線通常用於處理純文本數據，要處理二進制數據需要額外的工具。
2. 管線中出現錯誤時，難以定位是哪個指令導致。
3. 並行可能會導致某些情況下會因為輸入或輸出阻塞而降低效率。
